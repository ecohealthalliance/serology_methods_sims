################################################################################
#
# Project build script
#
################################################################################

# Load packages (in packages.R) and load project-specific functions in R folder
suppressPackageStartupMessages(source("packages.R"))
for (f in list.files(here::here("R"), full.names = TRUE)) source (f)

# Setup  ------------------------------------------------------------

## Setup for future package for parallelization. This is the max allowable number of workers
nworker <- 6
nthread <- 6
future::plan(list(tweak(future.callr::callr, workers = nworker), tweak(future.callr::callr, workers = nthread)))
future::plan(future.callr::callr, workers = nworker)

# Groups of targets ------------------------------------------------------------

## Group of targets associated with parameter choices that the user must define
setup_targets <- tar_plan(
  
    ## Establish what stan models to fit
    tar_target(models_to_fit,
      c(
   #    "mixing_simple_diff.stan"
   #  , "mixing_simple_diff_beta.stan"
        "mixing_simple_diff_beta2.stan"
      )
    )
    
    ## Into list for future and purrr::pmap
  , tar_target(stan_models.l, {
      data.frame(model = models_to_fit) %>% mutate(index = seq(n())) %>% split_tibble(., "index")
    })
    
    ## Establish parameters for the simulations
  , tar_target(sim.params,
      establish_parameters(
        n_param_sets  = 20
      , n_samps       = 1000
      , mu_neg        = -2.75
      , sd_neg        = 1
      , mu_pos_delta  = c(1, 5)
      , sd_pos_delta  = 0.5
      , lambda        = 0.2
      , lambda_age    = 0.2
      , beta_age      = 1
      , age_prop      = 0.5
     )
   )
  
)

## Simulate data from established parameters
simulation_targets <- tar_plan(
  
    ## Simulate data
    tar_target(sim.data,
      simulate_data(
        param_sets = sim.params
      )
    )
    
    ## Into list for future and purrr::pmap
  , tar_target(simulated_data.l, {
      sim.data %>% split_tibble(., "param_set")
    })
  
    ## Plot raw data
  , tar_target(data_plot,
      examine_data(
        simulated_data = sim.data
      )
    )
  
)

## fitting in a few ways
fitting_targets <- tar_plan(
  
    ## -- Two stage via mclust and then regression
  
    ## stage one: run mclust
    tar_target(mculst.groups,
      group_via_mculst(
        simulated_data = sim.data
      , param_sets     = sim.params
      )
    )
  
    ## stage two: run regression
  , tar_target(regressions.fit, 
      fit_regression(
        groups         = mculst.groups
      , param_sets     = sim.params
      )
    )
  
    ## -- One stage stan model
  
    ## Fir the stan models and return all the raw models in a list
  , tar_target(stan_fits.l, 
      fit_stan_models(
        simulated_data = simulated_data.l
      , param_sets     = sim.params
      , model_names    = stan_models.l
      )
    , pattern   = cross(simulated_data.l, stan_models.l)
    , iteration = "list"
   )
  
    ## Sort these output stan models into a sensible list object to combine with parameters for cleaning
  , tar_target(stan.fits,
      sort_stan_fits(
        stan_fits.l   = stan_fits.l
      , models_to_fit = models_to_fit
      )
    )
  
)

## Tidy up code returned by fitting targets
cleanup_targets <- tar_plan(
  
   ## Summarize regression fits
   tar_target(regressions.summary,
     sort_regression(
       fitted_regressions = regressions.fit
     , param_sets         = sim.params
     )
   )
  
   ## Summarize stan fits and combine with parameter values
 , tar_target(stan.summary,
      summarize_stan_fits(
        model_fits     = stan.fits
      , param_sets     = sim.params
      , stan_models    = models_to_fit
      )
    )

)

## plot output
plotting_targets <- tar_plan(
  
  ## Plot summaries
  tar_target(fit.plot,
    plot_summary(
      stan.sum   = stan.summary
    , mclust.sum = regressions.summary
    , param_sets = sim.params
    )
  )

)



# List targets -----------------------------------------------------------------

list(
  setup_targets
, simulation_targets
, fitting_targets
, cleanup_targets
, plotting_targets
  )
