## Build parameter sets from input parameter ranges
establish_parameters    <- function(n_param_sets, ...) {
  
needed_params      <- c(
  "n_samps", "n_sims_per_set"
, "mu_neg", "sd_neg", "mu_pos_delta", "sd_pos_delta"
, "beta_base", "beta_age_delta"
, "mu_theta_age"
, "age_prop"
)
model_input_params <- list(...) 
  
if (any(needed_params %notin% names(model_input_params))) {
  stop(paste(
    "Need parameter[s]:"
  , paste(needed_params[which(needed_params %notin% names(model_input_params))], collapse = " -- ")
  ))
}
  
point_vals <- which(lapply(model_input_params, length) %>% unlist() == 1)

model_input_params.p <- model_input_params[point_vals]
model_input_params.r <- model_input_params[-point_vals]
  
if (length(model_input_params.r) != 0) {
  if (n_param_sets > 1) {
     param_input_vals <- pomp::sobol_design(
       lower = lapply(model_input_params.r, FUN = function(x) x[1]) %>% unlist()
     , upper = lapply(model_input_params.r, FUN = function(x) x[2]) %>% unlist()
     , nseq  = n_param_sets
    )
  } else {
    param_input_vals <- lapply(model_input_params.r, FUN = function(x) median(x)) %>% as.data.frame()
  }
  
  model_params <- cbind(param_input_vals, data.frame(model_input_params.p))
  
} else {
  model_params <- data.frame(model_input_params.p)
}

model_params %<>% 
  dplyr::mutate(
    mu_pos = mu_neg + mu_pos_delta
  , sd_pos = sd_neg + sd_pos_delta) %>% 
  dplyr::mutate(param_set = seq(n()), .before = 1) %>%
  group_by(param_set)

purrr::map_dfr(seq_len(model_input_params$n_sims_per_set), ~model_params) %>%
  mutate(sim_num = seq(n()), .after = "param_set")
  
}

